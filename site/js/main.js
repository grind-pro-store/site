// GRIND PRO v3 main JS - cart & cardlist (localStorage)
(function(){
  const CART_KEY = 'grindpro_cart_v3';
  const CARD_KEY = 'grindpro_cardlist_v3';
  function read(k){ try{return JSON.parse(localStorage.getItem(k)||'[]')}catch(e){return[]} }
  function write(k,v){ localStorage.setItem(k,JSON.stringify(v)) }
  function updateCounts(){ const cc = document.getElementById('cart-count'); const wc = document.getElementById('wish-count'); const cart = read(CART_KEY), card = read(CARD_KEY); if(cc) cc.textContent = cart.reduce((s,i)=>s+Number(i.qty),0); if(wc) wc.textContent = card.length; }
  window.handleAddToCart = function(root){ const p = root.closest('[data-product]'); const id = p.getAttribute('data-product'); const name = p.querySelector('.product-title').innerText; const price = Number(p.getAttribute('data-price')); const img = p.querySelector('.main-image').getAttribute('src'); const colorEl = p.querySelector('[data-color].active'); const color = colorEl ? colorEl.getAttribute('data-color') : ''; const sizeEl = p.querySelector('[data-size].active'); const size = sizeEl ? sizeEl.getAttribute('data-size') : 'M'; const qty = Number(p.querySelector('.qty-input') ? p.querySelector('.qty-input').value : 1) || 1; const cart = read(CART_KEY); const existing = cart.find(i=>i.id===id && i.color===color && i.size===size); if(existing) existing.qty = Number(existing.qty) + qty; else cart.push({id,name,price,qty,color,size,img}); write(CART_KEY,cart); updateCounts(); showToast('Added to cart'); };
  window.handleAddToCardList = function(root){ const p = root.closest('[data-product]'); const id = p.getAttribute('data-product'); const name = p.querySelector('.product-title').innerText; const price = Number(p.getAttribute('data-price')); const img = p.querySelector('.main-image').getAttribute('src'); const colorEl = p.querySelector('[data-color].active'); const color = colorEl ? colorEl.getAttribute('data-color') : ''; const sizeEl = p.querySelector('[data-size].active'); const size = sizeEl ? sizeEl.getAttribute('data-size') : 'M'; const card = read(CARD_KEY); if(card.find(i=>i.id===id && i.color===color && i.size===size)){ showToast('Already in Card List'); setTimeout(()=>{window.location='cardlist.html'},800); return; } card.push({id,name,price,qty:1,color,size,img}); write(CARD_KEY,card); updateCounts(); showToast('✅ Added to Card List'); setTimeout(()=>{ window.location='cardlist.html' }, 1200); };
  function showToast(text){ let t = document.getElementById('grind-toast'); if(!t){ t = document.createElement('div'); t.id='grind-toast'; t.style.position='fixed'; t.style.right='16px'; t.style.top='16px'; t.style.padding='10px 14px'; t.style.background='rgba(0,0,0,0.8)'; t.style.color='#fff'; t.style.borderRadius='8px'; t.style.zIndex=9999; document.body.appendChild(t); } t.textContent = text; t.style.opacity=1; t.style.transition='opacity .3s ease'; setTimeout(()=>{ t.style.opacity=0 }, 2000); }
  window.initProductUI = function(root){ const container = root || document; container.querySelectorAll('.thumb').forEach(function(t){ t.addEventListener('click', function(){ container.querySelectorAll('.thumb').forEach(x=>x.classList.remove('active')); t.classList.add('active'); const main = container.querySelector('.main-image'); if(main) main.src = t.getAttribute('data-src'); }); }); container.querySelectorAll('[data-color]').forEach(function(b){ b.addEventListener('click', function(){ if(b.classList.contains('disabled')) return; const g=b.getAttribute('data-group'); container.querySelectorAll('[data-color][data-group=\"'+g+'\"]').forEach(x=>x.classList.remove('active')); b.classList.add('active'); const main = container.querySelector('.main-image'); if(main && b.getAttribute('data-src')) main.src=b.getAttribute('data-src'); }); }); container.querySelectorAll('[data-size]').forEach(function(s){ s.addEventListener('click', function(){ if(s.classList.contains('disabled')) return; container.querySelectorAll('[data-size]').forEach(x=>x.classList.remove('active')); s.classList.add('active'); }); }); };
  window.renderCardList = function(listEl, totalEl){ const card = read(CARD_KEY); listEl.innerHTML=''; let total=0; card.forEach((it,idx)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.gap='12px'; row.style.alignItems='center'; row.style.padding='10px 0'; row.style.borderBottom='1px solid #f2f2f2'; row.innerHTML = '<img src=\"'+it.img+'\" style=\"width:80px;border-radius:8px\"><div style=\"flex:1\"><strong>'+it.name+'</strong><div class=\"small\">Color: '+it.color+' • Size: '+it.size+'</div></div><div style=\"text-align:right\"><div>'+it.price+' DA</div><div style=\"margin-top:8px\"><input class=\"qty-input\" type=\"number\" min=\"1\" value=\"'+it.qty+'\" data-idx=\"'+idx+'\" style=\"width:64px;padding:8px;border-radius:8px;border:1px solid #e6e6e6\"></div><div style=\"margin-top:8px\"><button class=\"btn-secondary\" data-del=\"'+idx+'\">Delete</button></div></div>'; listEl.appendChild(row); total += it.price * it.qty; }); totalEl.textContent = total + ' DA'; listEl.querySelectorAll('.qty-input').forEach(function(inp){ inp.addEventListener('change', function(){ const i=Number(inp.getAttribute('data-idx')); const v=Number(inp.value)||1; const card=read(CARD_KEY); card[i].qty=v; write(CARD_KEY,card); renderCardList(listEl,totalEl); updateCounts(); }); }); listEl.querySelectorAll('[data-del]').forEach(function(b){ b.addEventListener('click', function(){ const i=Number(b.getAttribute('data-del')); const card=read(CARD_KEY); card.splice(i,1); write(CARD_KEY,card); renderCardList(listEl,totalEl); updateCounts(); }); }); };
  window.renderCart = function(tableBodyEl, totalEl){ const cart = read(CART_KEY); tableBodyEl.innerHTML=''; let total=0; cart.forEach((it,idx)=>{ const tr = document.createElement('tr'); tr.innerHTML = '<td><img src=\"'+it.img+'\" style=\"width:64px;border-radius:6px\"></td><td>'+it.name+'<div class=\"small\">Color: '+it.color+' • Size: '+it.size+'</div></td><td>'+it.price+' DA</td><td><input class=\"qty-input\" type=\"number\" min=\"1\" value=\"'+it.qty+'\" data-idx=\"'+idx+'\"></td><td>'+ (it.price*it.qty) +' DA</td><td><button class=\"btn-secondary\" data-del=\"'+idx+'\">Delete</button></td>'; tableBodyEl.appendChild(tr); total += it.price * it.qty; }); totalEl.textContent = total + ' DA'; tableBodyEl.querySelectorAll('.qty-input').forEach(function(inp){ inp.addEventListener('change', function(){ const i=Number(inp.getAttribute('data-idx')); const v=Number(inp.value)||1; const cart=read(CART_KEY); cart[i].qty=v; write(CART_KEY,cart); renderCart(tableBodyEl,totalEl); updateCounts(); }); }); tableBodyEl.querySelectorAll('[data-del]').forEach(function(b){ b.addEventListener('click', function(){ const i=Number(b.getAttribute('data-del')); const cart=read(CART_KEY); cart.splice(i,1); write(CART_KEY,cart); renderCart(tableBodyEl,totalEl); updateCounts(); }); }); };
  document.addEventListener('DOMContentLoaded', function(){ updateCounts(); });
})();